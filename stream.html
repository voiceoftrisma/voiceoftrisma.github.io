<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Radio Player</title>
    <style>
        body {
            margin: 0;
            background: #111;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: monospace;
        }

        audio {
            width: 500px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .status {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* MODIFIKASI: Log disembunyikan secara default */
        .log {
            display: none; /* Hidden by default */
            font-size: 11px;
            color: #00ff00;
            background: #000;
            width: 80%;
            font-family: 'Consolas', monospace;
            height: 150px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            margin-top: 10px;
        }

        .log div {
            margin-bottom: 2px;
            border-bottom: 1px solid #222;
        }

        #modeIndicator {
            font-size: 12px;
            color: #888;
            margin-top: 15px;
            padding: 5px 10px;
            border: 1px solid #333;
            border-radius: 3px;
        }
    </style>
</head>

<body>

    <audio id="player" crossorigin="anonymous" controls></audio>

    <div class="status" id="statusText">â–¶ PLAY</div>
    
    <div class="log" id="debugLog"></div>
    
    <div id="modeIndicator">System: IDLE</div>

    <script>
        const streamUrl = "https://i.klikhost.com:8502/stream";
        const player = document.getElementById('player');
        const statusText = document.getElementById('statusText');
        const debugLog = document.getElementById('debugLog');
        const modeIndicator = document.getElementById('modeIndicator');

        let retryInterval = null;
        let userHasInteracted = false;

        // --- MODIFIKASI: Cek URL Parameter (?debug=1 atau ?debug=true) ---
        const urlParams = new URLSearchParams(window.location.search);
        const debugParam = urlParams.get('debug');
        
        if (debugParam === '1' || debugParam === 'true') {
            debugLog.style.display = 'block'; // Tampilkan jika ada parameter
        }

        // --- Logger ---
        function log(msg, color = '#00ff00') {
            // Kita tetap menjalankan fungsi log di background walau hidden
            // supaya jika user inspect element, data tetap ada
            const time = new Date().toLocaleTimeString();
            const p = document.createElement('div');
            p.innerHTML = `<span style="color: #666;">[${time}]</span> <span style="color: ${color};">${msg}</span>`;
            debugLog.prepend(p);
            if (debugLog.children.length > 50) debugLog.lastChild.remove();
        }

        // --- Fungsi Panic Mode ---
        function startPanicMode() {
            if (retryInterval) return;

            log("âš ï¸ AUDIO MACET! Memulai panggilan berulang ke server...", "red");
            statusText.innerText = "ðŸ”„ RECONNECTING (PANIC MODE)...";
            statusText.style.color = "red";
            modeIndicator.innerText = "System: PANIC (Calling Server Loop)";
            modeIndicator.style.borderColor = "red";
            modeIndicator.style.color = "red";

            attemptReconnect();

            retryInterval = setInterval(() => {
                log("ðŸ“ž Memanggil server ulang...", "orange");
                attemptReconnect();
            }, 2500); 
        }

        function stopPanicMode() {
            if (retryInterval) {
                clearInterval(retryInterval);
                retryInterval = null;
                log("âœ… Audio Lancar Kembali. Stop memanggil server.", "#00ffff");
                modeIndicator.innerText = "System: STABLE (Silent Monitor)";
                modeIndicator.style.borderColor = "#4caf50";
                modeIndicator.style.color = "#4caf50";
            }
        }

        function attemptReconnect() {
            const timestamp = new Date().getTime();
            const newUrl = `${streamUrl}?t=${timestamp}`;
            const currentVol = player.volume;
            
            player.src = newUrl;
            player.volume = currentVol;
            player.load();
            
            const playPromise = player.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {}).catch(error => {
                    log("âŒ Gagal Play: " + error.message, "gray");
                });
            }
        }

        // --- Event Listeners ---
        player.addEventListener('playing', () => {
            userHasInteracted = true;
            statusText.innerText = "ðŸ”Š PLAYING (LIVE)";
            statusText.style.color = "#4caf50";
            stopPanicMode();
        });

        player.addEventListener('waiting', () => {
            if(userHasInteracted) {
                log("â³ Buffer terdeteksi...", "yellow");
                startPanicMode();
            }
        });

        player.addEventListener('stalled', () => {
            if(userHasInteracted) {
                log("ðŸš« Stream Stalled", "red");
                startPanicMode();
            }
        });

        player.addEventListener('error', (e) => {
            if(userHasInteracted) {
                log("â˜ ï¸ Error Terjadi", "red");
                startPanicMode();
            }
        });

        player.addEventListener('pause', () => {
            if (!retryInterval) {
                statusText.innerText = "â¸ PAUSED";
                statusText.style.color = "white";
                log("â¸ User menekan Pause.", "white");
                stopPanicMode();
                userHasInteracted = false;
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (player.paused) {
                    player.play();
                    userHasInteracted = true;
                } else {
                    player.pause();
                }
            }
        });

        player.src = streamUrl;
        log("Sistem Siap. Klik Play untuk memulai.", "white");

    </script>
</body>
</html>